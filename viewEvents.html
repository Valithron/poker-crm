<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>View Events</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
 <div id="navbar-placeholder"></div>


  <h1>🗓️ Poker Night Events</h1>
  <div id="eventList"></div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    collection,
    getDocs,
    getDoc,
    updateDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";


  const firebaseConfig = {
    apiKey: "AIzaSyDqLx1BmdM_01wmcOPPKyRh8PFnSw-dTH0",
    authDomain: "poker-crm.firebaseapp.com",
    projectId: "poker-crm",
    storageBucket: "poker-crm.appspot.com",
    messagingSenderId: "218784808902",
    appId: "1:218784808902:web:c587bdf584d704f7733107"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const eventList = document.getElementById("eventList");

  async function fetchPlayerNames(refs) {
    const names = [];
    for (const ref of refs || []) {
      try {
        const snap = await getDoc(ref);
        names.push(snap.exists() ? snap.data().name : "[Unknown]");
      } catch {
        names.push("[Error]");
      }
    }
    return names;
  }

  async function fetchEvents() {
    const snapshot = await getDocs(collection(db, "events"));
    const events = [];

    for (const docSnap of snapshot.docs) {
      const data = docSnap.data();

      // Handle both old "attendees" and new "invited"
      const invitedRefs = data.invited || data.attendees || [];
      const attendedRefs = data.attended || [];

      const invited = await fetchPlayerNames(invitedRefs);
      const attended = await fetchPlayerNames(attendedRefs);

      events.push({
  id: docSnap.id,  // ✅ Needed for updating this event later
  date: data.date?.toDate().toLocaleString() || "[No date]",
  notes: data.notes || "",
  invited,
  attended
});

    }

    renderEvents(events);
  }

  function renderEvents(events) {
    eventList.innerHTML = "";

    if (events.length === 0) {
      eventList.textContent = "No events found.";
      return;
    }

    events.sort((a, b) => new Date(b.date) - new Date(a.date));

    for (const event of events) {
      const div = document.createElement("div");
      div.className = "event";

      const attendedListHtml = event.attended.map(name => `
  <li>
    ${name}
    <button data-name="${name}" class="unmark" style="margin-left: 10px; font-size: 0.8rem;">
      ⛔ Unmark
    </button>
  </li>
`).join("");

div.innerHTML = `
  <h2>${event.date}</h2>
  <p><strong>Notes:</strong> ${event.notes || "—"}</p>

  <div class="attendees">
    <strong>Invited:</strong>
    <ul>${event.invited.map(name => `<li>${name}</li>`).join("")}</ul>
  </div>

  <div class="attendees">
    <strong>Attended:</strong>
    <ul id="attended-list-${event.id}">
      ${attendedListHtml || `<li><em>None marked yet</em></li>`}
    </ul>
  </div>
`;


      // Build dropdown
      const dropdown = document.createElement("select");
      dropdown.innerHTML = `<option value="">Select attendee...</option>`;
      for (let i = 0; i < event.invited.length; i++) {
        const name = event.invited[i];
        if (!event.attended.includes(name)) {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          dropdown.appendChild(option);
        }
      }

      const markBtn = document.createElement("button");
      markBtn.textContent = "✔️ Mark as Attended";
      markBtn.style.marginLeft = "1rem";

      const controls = document.createElement("div");
      controls.style.marginTop = "1rem";
      controls.appendChild(dropdown);
      controls.appendChild(markBtn);

      div.appendChild(controls);

      markBtn.addEventListener("click", async () => {
  const selectedName = dropdown.value;
  if (!selectedName) return alert("Please select someone to mark.");

  // Find the player by name
  const playersSnap = await getDocs(collection(db, "players"));
  let matchedDoc = null;
  playersSnap.forEach(docSnap => {
    const data = docSnap.data();
    if (data.name === selectedName) {
      matchedDoc = docSnap;
    }
  });

  if (!matchedDoc) {
    alert("Player not found.");
    return;
  }

  const playerRef = doc(db, "players", matchedDoc.id);
  const eventRef = doc(db, "events", event.id); // event.id now required!

  // Update event document: add player to attended
  const eventSnap = await getDoc(eventRef);
  const currentAttended = eventSnap.data().attended || [];
  const updatedAttended = [...currentAttended, playerRef];
  await updateDoc(eventRef, { attended: updatedAttended });

  // Update player document: add event date to attendance array
  const playerData = matchedDoc.data();
  const currentDates = playerData.attendance || [];
  const parsedDate = new Date(event.date);
  const updatedDates = [...currentDates, parsedDate];
  await updateDoc(playerRef, { attendance: updatedDates });

  // ✅ Visual Update (no reload!)
  const ul = div.querySelector(`#attended-list-${event.id}`);
  const li = document.createElement("li");
  li.textContent = selectedName;
  ul.appendChild(li);

  // Remove from dropdown
  dropdown.querySelector(`option[value="${selectedName}"]`)?.remove();

  // Reset dropdown
  dropdown.value = "";

  // Optional feedback
  markBtn.textContent = "✅ Marked!";
  markBtn.disabled = true;
  setTimeout(() => {
    markBtn.textContent = "✔️ Mark as Attended";
    markBtn.disabled = false;
  }, 1200);
});
// Attach unmark button listeners
div.querySelectorAll(".unmark").forEach(button => {
  button.addEventListener("click", async () => {
    const nameToRemove = button.dataset.name;
    if (!confirm(`Unmark ${nameToRemove} from attended?`)) return;

    // Lookup player doc by name
    const playersSnap = await getDocs(collection(db, "players"));
    let matchedDoc = null;
    playersSnap.forEach(docSnap => {
      if (docSnap.data().name === nameToRemove) {
        matchedDoc = docSnap;
      }
    });

    if (!matchedDoc) {
      alert("Player not found.");
      return;
    }

    const playerRef = doc(db, "players", matchedDoc.id);
    const eventRef = doc(db, "events", event.id); // event.id is available from earlier

    // Remove player from event.attended
    const eventSnap = await getDoc(eventRef);
    const currentRefs = eventSnap.data().attended || [];
    const updatedRefs = currentRefs.filter(ref => ref.path !== playerRef.path);
    await updateDoc(eventRef, { attended: updatedRefs });

    // Remove event date from player.attendance array
    const playerSnap = await getDoc(playerRef);
    const currentDates = playerSnap.data().attendance || [];

    const eventDate = new Date(event.date);
    const updatedDates = currentDates.filter(date => {
      const timestamp = date.seconds ? new Date(date.seconds * 1000) : new Date(date);
      return timestamp.getTime() !== eventDate.getTime();
    });

    await updateDoc(playerRef, { attendance: updatedDates });

    // ✅ Update UI
    button.closest("li")?.remove();

    alert(`${nameToRemove} has been unmarked.`);
  });
});

      eventList.appendChild(div);


    }
  }

  fetchEvents();
</script>

<script>
  fetch('nav.html')
    .then(res => res.text())
    .then(html => {
      document.getElementById('navbar-placeholder').innerHTML = html;

      const hamburger = document.getElementById('hamburgerBtn');
      const navLinks = document.getElementById('navLinks');
      hamburger?.addEventListener('click', () => {
        navLinks.classList.toggle('show');
      });
    });
</script>


</body>
</html>
