<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Attendance Analytics</title>
    <link rel="stylesheet" href="styles.css?v=3" />

  </head>
  <body>
    <div id="navbar-placeholder"></div>

    <main class="page-content">
      <div class="page-header mobile-offset">
        <h1 class="page-title">ðŸ“Š Attendance Analytics</h1>
      </div>
      <div class="stats">
        <div class="stat">
          <strong id="totalEvents">0</strong><br />Total Events
        </div>
        <div class="stat">
          <strong id="averageAttendance">0</strong><br />Avg Attendees per Event
        </div>
      </div>

      <div id="coreSummarySection">
        <h2
          style="text-align: center; font-size: 1.1rem; margin-bottom: 0.5rem"
        >
          BroTime Members
        </h2>
        <div id="coreSummary" class="core-summary"></div>
      </div>

      <div class="chart-container">
        <div id="topPlayersChart" style="width: 100%; height: 100%"></div>
        <p id="noDataMessage" style="text-align: center"></p>
      </div>
    </main>

    <script src="https://unpkg.com/react/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
        getDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDqLxlBmdM_O1wmeOPPKyRh8PFnSw-dTH0",
        authDomain: "poker-crm.firebaseapp.com",
        projectId: "poker-crm",
        storageBucket: "poker-crm.appspot.com",
        messagingSenderId: "218784808902",
        appId: "1:218784808902:web:c587bdf584d704f7733107",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      async function buildAnalytics() {
        try {
          const [playersSnap, eventsSnap] = await Promise.all([
            getDocs(collection(db, "players")),
            getDocs(collection(db, "events")),
          ]);

          const playerInfo = {};
          playersSnap.forEach((d) => {
            const data = d.data();
            playerInfo[d.id] = { name: data.name, role: data.role };
          });

          const lockedEvents = eventsSnap.docs.filter((d) => d.data().locked);
          const attendanceCounts = {};
          let totalAttendees = 0;

          for (const docSnap of lockedEvents) {
            const data = docSnap.data();
            for (const ref of data.attended || []) {
              try {
                const pRef = typeof ref === "string" ? doc(db, "players", ref) : ref;
                const pSnap = await getDoc(pRef);
                const name = pSnap.exists() ? pSnap.data().name : "[Unknown]";
                attendanceCounts[name] = (attendanceCounts[name] || 0) + 1;
                totalAttendees++;
              } catch {
                /* ignore */
              }
            }
          }

          const totalEvents = lockedEvents.length;
          const averageAttendance =
            totalEvents > 0 ? Math.round(totalAttendees / totalEvents) : 0;

          document.getElementById("totalEvents").textContent = totalEvents;
          document.getElementById("averageAttendance").textContent = averageAttendance;

          const players = Object.values(playerInfo).map((p) => ({
            name: p.name,
            role: p.role,
            count: attendanceCounts[p.name] || 0,
          }));

          const nameMap = {
            "Adam Oliver": "Adam",
            "Sterling Knight-Pinneo": "Sterling",
            "Julian Oliver": "Julian",
            "John Slaine": "John",
            "Isaiah Jeub": "Isaiah",
            "Nathan Sleeger": "Nathan",
          };

          const comparator = (a, b) => {
            if (b.count !== a.count) return b.count - a.count;
            return a.name.toLowerCase().localeCompare(b.name.toLowerCase());
          };

          const corePlayers = players
            .filter((p) => p.role === "core")
            .sort(comparator);

          const coreContainer = document.getElementById("coreSummary");
          coreContainer.innerHTML = "";
          corePlayers.forEach((p) => {
            const div = document.createElement("div");
            div.className = "core-member";
            const displayName = nameMap[p.name] || p.name;
            div.innerHTML = `<span>${displayName}</span><span class="badge">${p.count}</span>`;
            coreContainer.appendChild(div);
          });

          const sorted = players
            .filter((p) => p.role !== "core")
            .sort(comparator);

          const chartData = Object.entries(attendanceCounts)
            .map(([name, count]) => ({ name, count }))
            .sort((a, b) => a.name.localeCompare(b.name));

          console.log("chartData", chartData);

          const chartRoot = document.getElementById("topPlayersChart");
          const msgEl = document.getElementById("noDataMessage");
          chartRoot.innerHTML = "";

          if (chartData.length === 0) {
            msgEl.textContent =
              "No attendance data yet. Lock your events to begin tracking analytics.";
            return;
          }
          msgEl.textContent = "";

          const {
            ResponsiveContainer,
            BarChart,
            Bar,
            XAxis,
            YAxis,
            CartesianGrid,
            Tooltip,
          } = Recharts;

          ReactDOM.render(
            React.createElement(
              ResponsiveContainer,
              { width: "100%", height: 300 },
              React.createElement(
                BarChart,
                { data: chartData },
                React.createElement(CartesianGrid, { stroke: "#cccccc" }),
                React.createElement(XAxis, {
                  dataKey: "name",
                  tick: { fill: "#ffffff" },
                  angle: 45,
                  textAnchor: "start",
                }),
                React.createElement(YAxis, {
                  allowDecimals: false,
                  tick: { fill: "#ffffff" },
                }),
                React.createElement(Tooltip, {
                  contentStyle: { backgroundColor: "#000000", color: "#90ee90" },
                }),
                React.createElement(Bar, { dataKey: "count", fill: "#f5f5dc" })
              )
            ),
            chartRoot
          );
        } catch (err) {
          console.error("Failed to load analytics", err);
        }
      }

      window.addEventListener("DOMContentLoaded", buildAnalytics);
    </script>
    <script>
      fetch("nav.html")
        .then((res) => res.text())
        .then((html) => {
          document.getElementById("navbar-placeholder").innerHTML = html;

          const hamburger = document.getElementById("hamburgerBtn");
          const navLinks = document.getElementById("navLinks");
          hamburger?.addEventListener("click", () => {
            navLinks.classList.toggle("show");
          });

          document.addEventListener("click", (e) => {
            if (!navLinks.contains(e.target) && !hamburger.contains(e.target)) {
              navLinks.classList.remove("show");
            }
          });
        });
    </script>
  <script type="module" src="authGuard.js"></script>
  </body>
</html>
